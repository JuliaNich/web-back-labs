<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∏</title>

<style>
body {
    background: #fde7f3;
    font-family: Arial;
    margin: 0;
}

.container {
    padding: 20px;
    text-align: center;
}

#field {
    position: relative;
    width: 90vw;
    height: 60vh;
    margin: 0 auto;
    border: 2px solid #e6a6c7;
    background: #fff;
}

.gift {
    position: absolute;
    width: 60px;
    cursor: pointer;
}

#info {
    margin-top: 30px;
    min-height: 120px;
}

#error {
    color: red;
}
</style>
</head>

<body>
<div class="container">
    <h2>üéÅ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∏</h2>
    <p>–û—Å—Ç–∞–ª–æ—Å—å –∫–æ—Ä–æ–±–æ–∫: <span id="remaining">10</span></p>

    <div id="error"></div>
    <div id="field"></div>

    <div id="info"></div>
</div>
<script>
function getImage(name) {
    return `/static/lab9/images/${name}.jpg`;
}

async function loadGifts() {
    try {
        const res = await fetch('/lab9/api/gifts');
        const data = await res.json();

        document.getElementById('remaining').textContent = data.remaining;

        const field = document.getElementById('field');
        field.innerHTML = '';

        data.gifts.forEach(g => {
            const el = document.createElement('img');
            el.className = 'gift';
            el.style.top = g.top + '%';
            el.style.left = g.left + '%';

            if (g.opened) {
                el.src = getImage('opened');
                el.style.cursor = 'default';
                el.style.opacity = '0.5';
            } else {
                el.src = getImage('gift' + g.number);
                el.style.cursor = 'pointer';
                el.onclick = () => openGift(g.number, el);
            }

            el.onerror = function() {
                console.log('–ö–∞—Ä—Ç–∏–Ω–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞:', this.src);
                this.style.display = 'none';
                const emoji = document.createElement('div');
                emoji.textContent = 'üéÅ';
                emoji.style.position = 'absolute';
                emoji.style.top = g.top + '%';
                emoji.style.left = g.left + '%';
                emoji.style.fontSize = '40px';
                field.appendChild(emoji);
            };

            field.appendChild(el);
        });
    } catch (err) {
        console.error('Error:', err);
        document.getElementById('error').textContent = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
    }
}

async function openGift(number, el) {
    try {
        const res = await fetch('/lab9/api/open', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({number: number})
        });
        
        const data = await res.json();

        if (!data.success) {
            document.getElementById('error').textContent = data.error;
            return;
        }

        el.src = getImage('opened');
        el.onclick = null;
        el.style.cursor = 'default';
        el.style.opacity = '0.5';

        document.getElementById('info').innerHTML = `
            <img src="${getImage('opened_gift' + number)}" width="100" 
                 onerror="this.src='${getImage('opened')}'"><br>
            <strong>${data.message}</strong>
        `;

        loadGifts();
    } catch (err) {
        console.error('Error:', err);
        document.getElementById('error').textContent = '–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è';
    }
}

loadGifts();
</script>
</body>
</html>