<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>–ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∏</title>

<style>
body {
    background: #fde7f3;
    font-family: Arial;
    margin: 0;
}

.container {
    padding: 20px;
    text-align: center;
}

#field {
    position: relative;
    width: 90vw;
    height: 60vh;
    margin: 0 auto;
    border: 2px solid #e6a6c7;
    background: #fff;
}

.gift {
    position: absolute;
    width: 60px;
    cursor: pointer;
}

.locked {
    opacity: 0.4;
}

#info {
    margin-top: 30px;
    min-height: 120px;
}

#error {
    color: red;
}
</style>
</head>

<body>
<div class="container">
    <h2>üéÅ –ù–æ–≤–æ–≥–æ–¥–Ω–∏–µ –ø–æ–¥–∞—Ä–∫–∏</h2>
    <p>–û—Å—Ç–∞–ª–æ—Å—å –∫–æ—Ä–æ–±–æ–∫: <span id="remaining">10</span></p>

    <button id="santa" style="display:none;">üéÖ –î–µ–¥ –ú–æ—Ä–æ–∑</button>

    <div id="error"></div>
    <div id="field"></div>
    <div id="info"></div>
</div>

<script>
function getImage(name) {
     return `/static/lab9/images/${name}.jpg`;
}

async function loadGifts() {
    const res = await fetch('/lab9/api/gifts');
    const data = await res.json();

    document.getElementById('remaining').textContent = data.remaining;

    if (data.is_auth) {
        document.getElementById('santa').style.display = 'inline-block';
    }

    const field = document.getElementById('field');
    field.innerHTML = '';

    data.gifts.forEach(g => {
        const el = document.createElement('img');
        el.className = 'gift';
        el.style.top = g.top + '%';
        el.style.left = g.left + '%';

        if (g.opened) {
            el.src = getImage('opened');
            el.style.opacity = '0.5';
        } else if (g.auth_only && !data.is_auth) {
            el.src = getImage('gift' + g.number);
            el.classList.add('locked');
            el.onclick = () => alert('üîí –¢–æ–ª—å–∫–æ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–Ω—ã—Ö');
        } else {
            el.src = getImage('gift' + g.number);
            el.onclick = () => openGift(g.number, el);
        }

        field.appendChild(el);
    });
}

async function openGift(number, el) {
    const res = await fetch('/lab9/api/open', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({number: number})
    });

    const data = await res.json();

    if (!data.success) {
        document.getElementById('error').textContent = data.error;
        return;
    }

    document.getElementById('info').innerHTML = `
        <img src="${getImage('opened_gift' + number)}" width="100"><br>
        <strong>${data.message}</strong>
    `;

    loadGifts();
}

document.getElementById('santa').onclick = async () => {
    await fetch('/lab9/api/reset', {method: 'POST'});
    loadGifts();
};

loadGifts();
</script>
</body>
</html>